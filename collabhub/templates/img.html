<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Profile Picture Cropper</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css">
</head>

<body>
    <h1>Profile Picture Upload</h1>
    <form id="profile-form" method="POST" enctype="multipart/form-data">
        <input type="file" id="image" accept="image/*">
        <div id="croppie-container"></div>
        <button id="cropme">cropimg</button>
        <button type="submit" id="upload-button">Upload Profile</button>
        <img id="display" src="" alt="">
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.js"></script>
    <script>
        function dataURLToBlob(dataURL) {
            //data:image/jpeg;base64,${base64EncodedData}
            const parts = dataURL.split(',');
            const contentType = parts[0].split(':')[1].split(";")[0];
            const base64Data = parts[1];
            const binaryString = atob(base64Data);
            const arrayBuffer = new ArrayBuffer(binaryString.length);
            const uint8Array = new Uint8Array(arrayBuffer);
            for (let i = 0; i < binaryString.length; i++) {
                uint8Array[i] = binaryString.charCodeAt(i);
            }
            return new Blob([arrayBuffer], { type: contentType });
        }
        document.addEventListener('DOMContentLoaded', function () {
            let croppie;

            const imageInput = document.getElementById('image');
            const croppieContainer = document.getElementById('croppie-container');
            const uploadButton = document.getElementById('upload-button');
            const profileForm = document.getElementById('profile-form');
            const imggg = document.getElementById("display")
            const cropme = document.getElementById("cropme")
            let imgname = ""
            let imgtype = ""

            imageInput.addEventListener('change', function () {
                // ... (rest of the image loading and Croppie initialization logic)
                const image = this.files[0];
                imgname = image.name
                imgtype = image.type

                const reader = new FileReader();

                reader.onload = function (e) {
                    const url = e.target.result;
                    croppie = new Croppie(croppieContainer, {
                        viewport: { width: 200, height: 200, type: "circle" },
                        boundary: { width: 300, height: 300 },
                        showZoomer: true,
                        enforceBoundary: true,
                    });
                    croppie.bind({ url: url }).then(console.log("Bound it"));
                };

                reader.readAsDataURL(image);
            });

            cropme.addEventListener("click", (e) => {
                e.preventDefault();
                croppie.result({
                    format: "jpeg",
                })
                    .then(function (croppedImage) {
                        imggg.src = croppedImage

                        // Create a new Blob object with original file information
                        // const newFile = new Blob([blob], { type: image.type });
                        const newFileblob = dataURLToBlob(croppedImage)
                        console.log(newFileblob)

                        // Replace the original file selection with the new Blob
                        const fileobj = new File([newFileblob], imgname, { type: imgtype });
                        console.log(fileobj)

                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(fileobj);
                        imageInput.files = dataTransfer.files;
                        console.log(imageInput.files[0])
                        croppie.destroy()
                    });
            })
            uploadButton.addEventListener('click', function (event) {
                event.preventDefault(); // Prevent default form submission
            });
        });
    </script>
</body>

</html>